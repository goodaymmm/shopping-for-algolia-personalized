name: Build Electron App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest]
        include:
          - os: windows-latest
            platform: win
            artifact-name: windows
            artifact-path: |
              release/**/*.exe
              release/**/win-unpacked/**

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Ensure Tailwind CSS v3 compatibility
        run: |
          # Remove Tailwind v4 postcss plugin if it exists
          npm uninstall @tailwindcss/postcss --save-dev --force || true
          
          # Ensure Tailwind CSS v3 is installed
          npm install tailwindcss@3.4.1 --save-dev --force
          
          # Fix postcss.config.js to use standard Tailwind v3 format
          echo "module.exports = { plugins: { tailwindcss: {}, autoprefixer: {} } };" > postcss.config.js
          
          # Verify the fix
          echo "PostCSS config after fix:"
          cat postcss.config.js

      - name: Pre-install electron-builder dependencies
        run: |
          # Pre-install electron-builder dependencies to avoid download issues during build
          npx electron-builder install-app-deps --arch=x64 || true
      
      - name: Generate Amazon product data
        shell: bash
        run: |
          echo "Generating optimized Amazon product data..."
          # Check if data files already exist (from repository)
          if [ -f "src/data/amazon-products.json" ]; then
            echo "Amazon product data already exists in repository, skipping generation"
            echo "Existing data files:"
            ls -la src/data/ || dir src/data/
          else
            echo "Data files not found in repository, skipping generation for CI build"
            echo "Note: Run 'npm run preprocess-amazon-data' locally with Amazon data to generate files"
            # Create empty data directory for build to succeed
            mkdir -p src/data
            echo "[]" > src/data/amazon-products.json
            echo "[]" > src/data/products-fashion.json
            echo "[]" > src/data/products-electronics.json
            echo "[]" > src/data/products-other.json
          fi
        
      - name: Build TypeScript
        run: npm run build:all

      - name: Build Electron app (with retry on NSIS failure)
        shell: bash
        run: |
          # First attempt
          if ! npx electron-builder --${{ matrix.platform }}; then
            echo "First build attempt failed, retrying after clearing cache..."
            
            # Clear electron-builder cache
            npx electron-builder install-app-deps --arch=x64 --force || true
            rm -rf node_modules/.cache/electron-builder || true
            
            # Wait and retry
            sleep 10
            echo "Retrying build..."
            npx electron-builder --${{ matrix.platform }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List build artifacts
        shell: bash
        run: |
          echo "Contents of release directory:"
          ls -la release/ || echo "No release directory"
          find release -type f -name "*.exe" -o -name "*.AppImage" -o -name "*.dmg" 2>/dev/null || echo "No installers found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-build
          path: ${{ matrix.artifact-path }}
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-build/**/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}